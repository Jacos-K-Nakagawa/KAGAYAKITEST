#!/bin/sh

FWCMD="/sbin/iptables"

#ルールの初期化
${FWCMD} -F INPUT
${FWCMD} -F OUTPUT

#ポリシーの変更
${FWCMD} -P INPUT DROP
${FWCMD} -P OUTPUT ACCEPT

#入力側

##lo ループバックは通過させる
${FWCMD} -A INPUT -i lo -j ACCEPT

##通信開始済みパケットは通過させる 
${FWCMD} -A INPUT -p all -m state --state RELATED,ESTABLISHED -j ACCEPT

##ドロップするパケット
#Windowsファイル共有
${FWCMD} -A INPUT -p tcp -m multiport --dports 135,137-139,445  

##Excelで規定する範囲 ->

##ICMPパケットは通過許容数を設定して通過させる 
${FWCMD} -A INPUT -p icmp -m icmp --icmp-type 0 -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 30 --hashlimit-mode srcip --hashlimit-name i_0 --hashlimit-htable-expire 120000 -j ACCEPT 
${FWCMD} -A INPUT -p icmp -m icmp --icmp-type 3 -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 30 --hashlimit-mode srcip --hashlimit-name i_3 --hashlimit-htable-expire 120000 -j ACCEPT 
${FWCMD} -A INPUT -p icmp -m icmp --icmp-type 4 -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 30 --hashlimit-mode srcip --hashlimit-name i_4 --hashlimit-htable-expire 120000 -j ACCEPT 
${FWCMD} -A INPUT -p icmp -m icmp --icmp-type 8 -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 30 --hashlimit-mode srcip --hashlimit-name i_8 --hashlimit-htable-expire 120000 -j ACCEPT 
${FWCMD} -A INPUT -p icmp -m icmp --icmp-type 11 -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 30 --hashlimit-mode srcip --hashlimit-name i_11 --hashlimit-htable-expire 120000 -j ACCEPT 
${FWCMD} -A INPUT -p icmp -m icmp --icmp-type 12 -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 30 --hashlimit-mode srcip --hashlimit-name i_12 --hashlimit-htable-expire 120000 -j ACCEPT 

##httpとhttpsは通過許容数を設定して通過させる
${FWCMD} -A INPUT -p tcp -m tcp --dport 80 -m state --state NEW --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 500 --hashlimit-mode srcip --hashlimit-name t_http --hashlimit-htable-expire 120000 -j ACCEPT 
${FWCMD} -A INPUT -p tcp -m tcp --dport 443 -m state --state NEW --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 500 --hashlimit-mode srcip --hashlimit-name t_https --hashlimit-htable-expire 120000 -j ACCEPT 

##ftpは通過許容数を設定して通過させる。
${FWCMD} -A INPUT -p tcp -m tcp --dport 21 -m state --state NEW --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 5 --hashlimit-mode srcip --hashlimit-name t_ftp --hashlimit-htable-expire 120000 -j ACCEPT

##sshは通過許容数を設定して通過させる
${FWCMD} -A INPUT -s 172.16.100.0/24 -p tcp -m state --state NEW -m tcp --dport 22 --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 20 --hashlimit-mode srcip --hashlimit-name t_sshd --hashlimit-htable-expire 120000 -j ACCEPT
${FWCMD} -A INPUT -s 192.168.1.0/24 -p tcp -m state --state NEW -m tcp --dport 22 --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 20 --hashlimit-mode srcip --hashlimit-name t_sshd --hashlimit-htable-expire 120000 -j ACCEPT
${FWCMD} -A INPUT -s 210.196.144.46 -p tcp -m state --state NEW -m tcp --dport 22 --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 20 --hashlimit-mode srcip --hashlimit-name t_sshd --hashlimit-htable-expire 120000 -j ACCEPT
${FWCMD} -A INPUT -s 202.213.208.160/29 -p tcp -m state --state NEW -m tcp --dport 22 --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 20 --hashlimit-mode srcip --hashlimit-name t_sshd --hashlimit-htable-expire 120000 -j ACCEPT
${FWCMD} -A INPUT -s 219.123.157.208/29 -p tcp -m state --state NEW -m tcp --dport 22 --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 20 --hashlimit-mode srcip --hashlimit-name t_sshd --hashlimit-htable-expire 120000 -j ACCEPT
${FWCMD} -A INPUT -s 221.255.92.16/28 -p tcp -m state --state NEW -m tcp --dport 22 --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 20 --hashlimit-mode srcip --hashlimit-name t_sshd --hashlimit-htable-expire 120000 -j ACCEPT

##rsyncは通過許容数を設定して通過させる
${FWCMD} -A INPUT -p tcp -m state --state NEW -m tcp --dport 873 --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 5 --hashlimit-mode srcip --hashlimit-name t_rsyncd --hashlimit-htable-expire 120000 -j ACCEPT

##TCP(999)は通過許容数を設定して通過させる
${FWCMD} -A INPUT -p tcp -m state --state NEW -m tcp --dport 999 --tcp-flags FIN,SYN,RST,ACK SYN -m hashlimit --hashlimit-upto 1/min --hashlimit-burst 5 --hashlimit-mode srcip --hashlimit-name t_999d --hashlimit-htable-expire 120000 -j ACCEPT

##ntpは通過させる
${FWCMD} -A INPUT -p udp -m udp --dport 123 -j ACCEPT 
${FWCMD} -A INPUT -p tcp -m tcp --dport 123 -j ACCEPT 

##Excelで規定する範囲 <-

#ルールにマッチしなかったパケットをログに記録する
${FWCMD} -A INPUT -j LOG

##現在の定義から変更している点
##到着の多そうなパケットから順に評価するように定義順を変更した。これにより、評価の回数を減らしパフォーマンスを改善する。
##また、拒否するルールをはじめの方に定義する。
##DDoS攻撃に対する備えとしてIPアドレス１つからの接続数を制限する。当面http系は500、SSHは20、それ以外は5とする。
##DMZと社内から来るパケットを容認する。
